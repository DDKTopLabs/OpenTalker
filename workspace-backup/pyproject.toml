# ============================================
# é¡¹ç›®åŸºæœ¬ä¿¡æ¯
# ============================================
[project]
name = "opentalker"
version = "0.1.0"
description = "OpenAI-compatible API server for Qwen3-ASR and IndexTTS2 (GTX 1050 Ti optimized, China mirrors)"
readme = "README.md"
requires-python = ">=3.10,<3.13"
license = { text = "Apache-2.0" }
authors = [
    { name = "DDKTopLabs", email = "contact@ddktop.com" }
]
keywords = ["speech-recognition", "text-to-speech", "qwen", "indextts", "openai-api"]

# ============================================
# é¡¹ç›®ä¾èµ–
# ============================================
dependencies = [
    # Web æ¡†æ¶
    "fastapi>=0.109.0",
    "uvicorn[standard]>=0.27.0",
    "python-multipart>=0.0.6",
    "pydantic>=2.5.0",
    "pydantic-settings>=2.1.0",
    
    # æ·±åº¦å­¦ä¹ æ¡†æ¶ï¼ˆå°†ä» PyTorch æ¸…åé•œåƒå®‰è£…ï¼‰
    "torch>=2.1.0",
    "torchaudio>=2.1.0",
    "transformers>=4.40.0",
    
    # STT (Qwen3-ASR)
    "qwen-asr>=0.0.6",
    
    # TTS (IndexTTS2) ä¾èµ–
    "sentencepiece>=0.1.99",
    "librosa>=0.10.0",
    "soundfile>=0.12.0",
    "scipy>=1.10.0",
    "numpy>=1.24.0,<2.0.0",
    
    # éŸ³é¢‘å¤„ç†
    "ffmpeg-python>=0.2.0",
    
    # å·¥å…·
    "tqdm>=4.65.0",
    "python-dotenv>=1.0.0",
    "requests>=2.31.0",
]

# å¼€å‘ä¾èµ–
[project.optional-dependencies]
dev = [
    "pytest>=7.4.0",
    "pytest-asyncio>=0.21.0",
    "pytest-cov>=4.1.0",
    "httpx>=0.25.0",
    "black>=23.0.0",
    "ruff>=0.1.0",
    "mypy>=1.5.0",
]

# ============================================
# æ„å»ºç³»ç»Ÿ
# ============================================
[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

# é…ç½® hatchling æ‰¾åˆ° app ç›®å½•
[tool.hatch.build.targets.wheel]
packages = ["app", "scripts"]

# ============================================
# uv åŒ…æºé…ç½®ï¼ˆå…³é”®ï¼ï¼‰
# ============================================

# ğŸ”¥ å°† PyTorch ç›¸å…³åŒ…å›ºå®šåˆ°æ¸…å PyTorch é•œåƒ
[tool.uv.sources]
torch = { index = "tsinghua-pytorch" }
torchaudio = { index = "tsinghua-pytorch" }
torchvision = { index = "tsinghua-pytorch" }

# ============================================
# uv ç´¢å¼•é…ç½®
# ============================================

# ç´¢å¼• 1ï¼šæ¸…å PyPI é•œåƒï¼ˆé»˜è®¤ç´¢å¼•ï¼Œæœ€ä½ä¼˜å…ˆçº§ï¼‰
[[tool.uv.index]]
name = "tsinghua-pypi"
url = "https://pypi.tuna.tsinghua.edu.cn/simple"
default = true

# ç´¢å¼• 2ï¼šæ¸…å PyTorch é•œåƒï¼ˆæ˜¾å¼ç´¢å¼•ï¼Œä»…ç”¨äºå›ºå®šçš„åŒ…ï¼‰
[[tool.uv.index]]
name = "tsinghua-pytorch"
url = "https://mirrors.tuna.tsinghua.edu.cn/pytorch/whl/cu121"
explicit = true

# ç´¢å¼• 3ï¼šå¤‡ç”¨å®˜æ–¹ PyPIï¼ˆå®¹é”™ï¼‰
[[tool.uv.index]]
name = "pypi-official"
url = "https://pypi.org/simple"

# ç´¢å¼• 4ï¼šå¤‡ç”¨å®˜æ–¹ PyTorchï¼ˆå®¹é”™ï¼‰
[[tool.uv.index]]
name = "pytorch-official"
url = "https://download.pytorch.org/whl/cu121"
explicit = true

# ============================================
# ä»£ç è´¨é‡å·¥å…·é…ç½®
# ============================================

[tool.ruff]
line-length = 100
target-version = "py310"
select = ["E", "F", "I", "N", "W"]
ignore = ["E501"]

[tool.black]
line-length = 100
target-version = ['py310', 'py311', 'py312']
include = '\.pyi?$'

[tool.mypy]
python_version = "3.10"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = false

[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = ["test_*.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
addopts = "-v --cov=app --cov-report=term-missing"
markers = [
    "gpu: marks tests as requiring GPU (deselect with '-m \"not gpu\"')",
    "slow: marks tests as slow (deselect with '-m \"not slow\"')",
]

[tool.bandit]
exclude_dirs = ["tests", ".venv", "venv"]
skips = ["B101", "B601"]
