name: Dependency Updates

on:
  schedule:
    # Run every Monday at 00:00 UTC (8:00 AM Beijing Time)
    - cron: '0 0 * * 1'
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"

jobs:
  check-updates:
    name: Check for Dependency Updates
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-uv-deps-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-deps-

      - name: Check for outdated dependencies
        id: check
        run: |
          uv venv
          source .venv/bin/activate
          
          # Install current dependencies
          uv pip install -e ".[dev]"
          
          # Check for outdated packages
          echo "Checking for outdated packages..."
          uv pip list --outdated > outdated.txt || true
          
          if [ -s outdated.txt ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "Updates available:"
            cat outdated.txt
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "All dependencies are up to date!"
          fi

      - name: Update dependencies
        if: steps.check.outputs.has_updates == 'true'
        run: |
          source .venv/bin/activate
          
          # Create backup
          cp pyproject.toml pyproject.toml.bak
          
          # Update dependencies (excluding pinned versions)
          echo "Updating dependencies..."
          uv pip install --upgrade -e ".[dev]"
          
          # Generate updated requirements for documentation
          uv pip freeze > requirements-updated.txt

      - name: Run tests with updated dependencies
        if: steps.check.outputs.has_updates == 'true'
        run: |
          source .venv/bin/activate
          
          # Install CPU-only PyTorch for testing
          uv pip install torch torchaudio --index-url https://download.pytorch.org/whl/cpu
          
          # Run tests
          pytest tests/ -v -m "not gpu" || echo "test_failed=true" >> $GITHUB_OUTPUT
        env:
          CUDA_VISIBLE_DEVICES: ""
        continue-on-error: true

      - name: Create Pull Request
        if: steps.check.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(deps): update dependencies"
          title: "chore(deps): Weekly dependency updates"
          body: |
            ## Dependency Updates
            
            This PR updates project dependencies to their latest versions.
            
            ### Changes
            
            The following packages have updates available:
            
            ```
            $(cat outdated.txt)
            ```
            
            ### Testing
            
            - [x] Automated tests have been run
            - [ ] Manual testing required for major version updates
            
            ### Notes
            
            - This PR was automatically generated by the dependency update workflow
            - Please review the changes carefully, especially for major version updates
            - Check the changelog of updated packages for breaking changes
            - Test thoroughly before merging
            
            ### Checklist
            
            - [ ] Review updated package versions
            - [ ] Check for breaking changes in changelogs
            - [ ] Run manual tests if needed
            - [ ] Update documentation if APIs changed
            
            ---
            
            Generated by GitHub Actions on $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          branch: deps/weekly-updates-${{ github.run_number }}
          delete-branch: true
          labels: |
            dependencies
            automated
          assignees: ${{ github.repository_owner }}

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"
          uv pip install safety pip-audit

      - name: Run safety check
        run: |
          source .venv/bin/activate
          safety check --json > safety-report.json || true
          cat safety-report.json
        continue-on-error: true

      - name: Run pip-audit
        run: |
          source .venv/bin/activate
          pip-audit --format json > pip-audit-report.json || true
          cat pip-audit-report.json
        continue-on-error: true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            safety-report.json
            pip-audit-report.json
          retention-days: 30

      - name: Create security issue if vulnerabilities found
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let safetyReport = '';
            let pipAuditReport = '';
            
            try {
              safetyReport = fs.readFileSync('safety-report.json', 'utf8');
            } catch (e) {}
            
            try {
              pipAuditReport = fs.readFileSync('pip-audit-report.json', 'utf8');
            } catch (e) {}
            
            const issueBody = `## Security Vulnerabilities Detected
            
            The weekly security audit has detected potential vulnerabilities in project dependencies.
            
            ### Safety Report
            
            \`\`\`json
            ${safetyReport}
            \`\`\`
            
            ### Pip-Audit Report
            
            \`\`\`json
            ${pipAuditReport}
            \`\`\`
            
            ### Action Required
            
            Please review these vulnerabilities and update the affected packages as soon as possible.
            
            ---
            
            Generated by GitHub Actions on ${new Date().toISOString()}
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”’ Security: Vulnerabilities detected in dependencies',
              body: issueBody,
              labels: ['security', 'dependencies', 'automated']
            });
